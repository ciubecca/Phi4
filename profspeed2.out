Timer unit: 1e-06 s

Total time: 83.2705 s
File: /Users/lorenzovitale/Phi4/matrix.py
Function: buildMatrix at line 76

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
    76                                               @profile
    77                                               def buildMatrix(self, Vlist, ignKeyErr=False, idxList=None, sumTranspose=False):
    78                                                   """
    79                                                   Vlist: list of oscillators
    80                                                   ignKeyErr: whether LookupError when generating a state should be ignored (to be used
    81                                                   when the lookupbasis does not contain all the states between Emin and Emax)
    82                                                   idxList: list of the row indices to be computed
    83                                                   sumTranspose: whether the tranpose of the matrix should be added and the diagonal
    84                                                   subtracted
    85                                                   """
    86                                           
    87        10           42      4.2      0.0          basis = self.basis
    88        10           12      1.2      0.0          lookupbasis = self.lookupbasis
    89        10            9      0.9      0.0          Erange = self.Erange
    90        10           11      1.1      0.0          statePos = self.statePos
    91        10           10      1.0      0.0          helper = self.helper
    92                                           
    93        10           26      2.6      0.0          if idxList==None:
    94         6           37      6.2      0.0              idxList = range(basis.size)
    95                                           
    96                                                   # Will construct the sparse matrix in the COO format and then convert it to CSC
    97        10            9      0.9      0.0          data = []
    98        10            9      0.9      0.0          row = []
    99        10            8      0.8      0.0          col = []
   100                                           
   101        51           54      1.1      0.0          for V in Vlist:
   102    165671       124392      0.8      0.1              for i in idxList:
   103                                                           colpart, datapart = \
   104    165630       167163      1.0      0.2                      V.computeMatrixElements(basis,i,lookupbasis, Erange=Erange,
   105    165630     81098886    489.6     97.4                              statePos=statePos, helper=helper, ignKeyErr=ignKeyErr)
   106    165630       211908      1.3      0.3                  data += datapart
   107    165630       187950      1.1      0.2                  col += colpart
   108    165630       300878      1.8      0.4                  row += [i]*len(colpart)
   109                                           
   110                                                   # XXX Does this sum duplicate entries?
   111        10      1174299 117429.9      1.4          V = scipy.sparse.coo_matrix((data,(row,col)), shape=(basis.size,lookupbasis.size))
   112                                           
   113        10           17      1.7      0.0          if sumTranspose:
   114                                                       # Add the matrix to its transpose and subtract the diagonal
   115         2         1104    552.0      0.0              diag_V = scipy.sparse.spdiags(V.diagonal(),0,basis.size,basis.size).tocsc()
   116         2         3666   1833.0      0.0              return (V+V.transpose()-diag_V)
   117                                                   else:
   118         8            5      0.6      0.0              return V

